control 'SV-89527' do
  title 'The MQ Appliance messaging server must provide centralized management and configuration of the content to be captured in log records generated by all application components.'
  desc 'A clustered messaging server is made up of several servers working together to provide the user a failover and increased computing capability.  To facilitate uniform logging in the event of an incident and later forensic investigation, the record format and logable events need to be uniform.  This can be managed best from a centralized server.

Without the ability to centrally manage the content captured in the log records, identification, troubleshooting, and correlation of suspicious behavior would be difficult and could lead to a delayed or incomplete analysis of an ongoing attack.

The MQ appliance is designed to be used in a redundant HQ configuration which will provide a means of centralized management of log activity.

Rudimentary instructions for determining if HA is set up are included here. To ensure proper configuration, system HA design steps must be taken and implemented. Reference vendor documentation for complete instructions on setting up HA: https://ibm.biz/BdicC7

Note: The queue manager’s data (queues, queue messages etc.) are replicated from the appliance in the primary HA role (first appliance) to the appliance in the secondary HA role (second appliance).

Ref.: Configuring high availability queue managers  https://goo.gl/xAqNTX'
  desc 'check', 'Review system categorization to determine if redundancy is a requirement.  If system categorization does not specify redundancy, interview system administrator to determine how they have configured the centralized log management solution for the MQ appliance.

On each member of the HA pair:
Establish an SSH command line session as an admin user.

To access the MQ Appliance CLI, enter:
mqcli

To run the dspmq command, enter:
dspmq -s -o ha

One of the appliances should be running as primary, the other as secondary.

If HA is not configured and the primary and secondary running, or if there is no centralized management solution in place to manage MQ logs, this is a finding.'
  desc 'fix', 'To configure HA:
1. Use three Ethernet cables to directly connect two appliances together using ports eth1, eth2, and eth3.
2. Configure the three connected MQ Appliance ports (on both appliances) as follows:

Interface  Purpose                                                 IP address/CIDR
eth1           HA group primary interface          x.x.x.x/24
eth2           HA group alternative interface   x.x.x.x/24
eth3           HA Replication interface               x.x.x.x/24

On the second appliance, enter the following command from the MQ Appliance CLI:
prepareha -s [SecretText] -a [eth 1 IPAddress of first appliance] [-t timeout]

On the first appliance, enter the following command:
crthagrp -s [SecretText] -a [eth 1 IPAddress of second appliance]

On the first appliance, stop the queue manager to be HA-enabled:
endmqm [name of queue manager]  
sethagrp -i [name of queue manager]

Note: The queue manager’s data (queues, queue messages, etc.) are replicated from the appliance in the primary HA role (first appliance) to the appliance in the secondary HA role (second appliance).'
  impact 0.5
  ref 'DPMS Target IBM MQ Appliance v9.0 AS'
  tag check_id: 'C-74711r1_chk'
  tag severity: 'medium'
  tag gid: 'V-74853'
  tag rid: 'SV-89527r1_rule'
  tag stig_id: 'MQMH-AS-001300'
  tag gtitle: 'SRG-APP-000356-AS-000202'
  tag fix_id: 'F-81469r1_fix'
  tag 'documentable'
  tag cci: ['CCI-001844']
  tag nist: ['AU-3 (2)']
end
