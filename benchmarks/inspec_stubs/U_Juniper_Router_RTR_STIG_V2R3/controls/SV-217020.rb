control 'SV-217020' do
  title 'The Juniper router must be configured to drop all fragmented Internet Control Message Protocol (ICMP) packets destined to itself.'
  desc "Fragmented ICMP packets can be generated by hackers for DoS attacks such as Ping O' Death and Teardrop. It is imperative that all fragmented ICMP packets are dropped."
  desc 'check', 'Review the filter that is applied inbound to the loopback interface and verify that it discards fragmented ICMP packets as shown in the example below.

firewall {
    family inet {
       …
       …
       …
        }
        filter DESTINED_TO_RE {
           …
           …
           …
            }
            term BLOCK_ICMP_FRAG {
                from {
                    is-fragment;
                    protocol icmp;
                }
                then {
                    discard;
                }
            }
            term ICMP_ANY {
                from {
                    protocol icmp;
                }
                then accept;
            }
            term DENY_BY_DEFAULT {
                then {
                    log;
                    discard;
                }
            }
        }
    }

If the router is not configured to filter to drop all fragmented ICMP packets destined to itself, this is a finding.'
  desc 'fix', 'Configure the filter that is applied inbound to the loopback interface to drop all fragmented ICMP packets as shown in the example below.

[edit firewall family inet filter DESTINED_TO_RP]
set term BLOCK_ICMP_FRAG from protocol icmp is-fragment
set term BLOCK_ICMP_FRAG then discard
insert term BLOCK_ICMP_FRAG before term DENY_BY_DEFAULT'
  impact 0.5
  ref 'DPMS Target Juniper Router RTR'
  tag check_id: 'C-18249r296928_chk'
  tag severity: 'medium'
  tag gid: 'V-217020'
  tag rid: 'SV-217020r604135_rule'
  tag stig_id: 'JUNI-RT-000140'
  tag gtitle: 'SRG-NET-000205-RTR-000002'
  tag fix_id: 'F-18247r296929_fix'
  tag 'documentable'
  tag legacy: ['SV-101035', 'V-90825']
  tag cci: ['CCI-001097']
  tag nist: ['SC-7 a']
end
