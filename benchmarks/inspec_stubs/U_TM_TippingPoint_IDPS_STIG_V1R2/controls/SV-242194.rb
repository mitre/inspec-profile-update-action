control 'SV-242194' do
  title 'The TPS must block outbound ICMP Destination Unreachable, Redirect, and Address Mask reply messages.'
  desc 'Internet Control Message Protocol (ICMP) messages are used to provide feedback about problems in the network. These messages are sent back to the sender to support diagnostics. However, some messages can also provide host information and network topology that may be exploited by an attacker.

A TPS must be configured to "silently drop" the packet and not send an ICMP control message back to the source. In some cases, it may be necessary to direct the traffic to a null interface.

Three ICMP messages are commonly used by attackers for network mapping: Destination Unreachable, Redirect, and Address Mask Reply.

These responses must be blocked on external interfaces; however, blocking the Destination Unreachable response will prevent Path Maximum Transmission Unit Discovery (PMTUD), which relies on the response "ICMP Destination Unreachable--Fragmentation Needed but DF Bit Set". PMTUD is a useful function and should only be "broken" after careful consideration.

An acceptable alternative to blocking all Destination Unreachable responses is to filter Destination Unreachable messages generated by the IDPS to allow ICMP Destination Unreachable--Fragmentation Needed but DF Bit Set (Type 3, Code 4) and apply this filter to the external interfaces.'
  desc 'check', %q(1. In the Trend Micro SMS, navigate to "Profiles" and "Inspection Profiles" and select the organization's profile. 
2. If there is not one configured, select "Default". 
3. Click "Search". 
4. Under "Filter criteria", select all "Filter categories". Select the "Filter Name" section. If the following filter names are not set to Block+Notify, this is a finding: 
- 0137: ICMP: Unreachable (All codes)
- 0157: ICMP: Redirect Net
- 0158: ICMP: Redirect Host
- 0159: ICMP: Redirect for TOS and Network
- 0160: ICMP: Redirect for TOS and Host
- 0161: ICMP: Redirect Undefined Code
- 5084:  ICMP: Address Mask Request (type 17)
- 41039: ICMP: Address Mask Reply (Type 18)

If there are no ICMP Destination Unreachable, Redirect, and Address Mask reply message policies defined, this is a finding.

Note: If the site has set up a security profile (i.e., not using the default profile), then this should be inspected using the site's SSP for compliance.)
  desc 'fix', %q(1. In the Trend Micro SMS, navigate to "Profiles" and "Inspection Profiles" and select the organization's profile. 
2. If there is not one configured, select "Default". 
3. Click "Traffic Management". Create a separate policy for each type of ICMP message.
4. Click New. 
   a. Under name type a name.
   b. Action: Block 
   c. Direction: Ensure the direction for Outbound ports are selected correctly. 
   d. Protocol: ICMP 
   e. Type: 3 
   f. Source address: any 
   g. Destination Address: any 
   h. Repeat previous steps for Types 5 and 18.

Note: If the site has set up a security profile (i.e., not using the default profile), then this should be inspected using the site's SSP for compliance.)
  impact 0.5
  ref 'DPMS Target Trend Micro TippingPoint IDPS'
  tag check_id: 'C-45469r840194_chk'
  tag severity: 'medium'
  tag gid: 'V-242194'
  tag rid: 'SV-242194r840196_rule'
  tag stig_id: 'TIPP-IP-000290'
  tag gtitle: 'SRG-NET-000273-IDPS-00198'
  tag fix_id: 'F-45427r840195_fix'
  tag 'documentable'
  tag cci: ['CCI-001312']
  tag nist: ['SI-11 a']
end
